<!DOCTYPE html>
<html lang="fr-FR">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <script type="text/javascript">
      
      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        window.location.href = 'https://' + window.location.host + window.location.pathname + window.location.search;
      }
    </script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Cryptic archive | </title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Un writeup détaillé pour le défi de cryptographie en 2025.">
    <meta name="generator" content="Hugo 0.142.0">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/writeups/2025/crypto/cryptic-archive/">
    

    <meta property="og:url" content="http://localhost:1313/writeups/2025/crypto/cryptic-archive/">
  <meta property="og:title" content="Cryptic archive">
  <meta property="og:description" content="Un writeup détaillé pour le défi de cryptographie en 2025.">
  <meta property="og:locale" content="fr_FR">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writeups">

  <meta itemprop="name" content="Cryptic archive">
  <meta itemprop="description" content="Un writeup détaillé pour le défi de cryptographie en 2025.">
  <meta itemprop="wordCount" content="1009">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Cryptic archive">
  <meta name="twitter:description" content="Un writeup détaillé pour le défi de cryptographie en 2025.">


    

    
    
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  
  
  <header class="contain bg-center bg-black" style="background-image: url('http://localhost:1313/images/background.svg');">
    
    <div class="bg-black-10">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        <img src="/images/logo.svg" class="w100 mw5-ns" alt="" />
      
    </a>
    <div id="dropdown-list" class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
            
              <li class="list f5 f4-ns fw4 dib pr3">
                <a class="hover-white no-underline white-90" href="/inscriptions/" title="Inscriptions page">
                  Inscriptions
                </a>
              </li>
            
          
            
              <li class="list f5 f4-ns fw4 dib pr3">
                <a class="hover-white no-underline white-90" href="/post/" title="Editions Précedentes page">
                  Editions Précedentes
                </a>
              </li>
            
          
            
              <li class="list f5 f4-ns fw4 dib has-dropdown pr3">
                <a class="hover-white no-underline white-90" href="/writeups/" title="Write-Ups page">
                  Write-Ups
                </a>
                <ul class="dropdown">
                  
                    <li class="f5 f4-ns fw4 dib pr3">
                      <a class="hover-white no-underline white-90" href="/writeups/2026/" title="Write-ups 2026 page">
                        Write-ups 2026
                      </a>
                    </li>
                  
                </ul>
              </li>
            
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv4 pv6-l ph3 ph4-ns">
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Write-ups 2025
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Cryptic archive</h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l"><h3 id="index-des-challenges">Index des challenges</h3>
<ul>
<li><a href="/writeups/2025/crypto/tchernobyl/">Fantome de Tchernobyl</a></li>
<li><a href="/writeups/2025/crypto/potdemiel/">Pot de miel</a></li>
<li><a href="/writeups/2025/crypto/twister/">Twister</a></li>
<li><a href="/writeups/2025/crypto/oceanofvalues/">Ocean of values</a></li>
<li><a href="/writeups/2025/crypto/cryptic-archive/">Cryptic archive</a></li>
<li><a href="/writeups/2025/crypto/pemp-my-key/">Pemp my key</a></li>
</ul>
<hr>
<p>Les sources du challenge sont disponibles <a href="https://github.com/JeanneD-Hack-CTF/JeanneD-Hack-CTF-2025/tree/main/crypto/Cryptic_archive">ici</a>.</p>
<blockquote>
<p><strong>Énoncé</strong></p>
<p>Durant leur dernière assaut numérique sur le site de propagande du gouvernement cybernétique, Jeanne d&rsquo;Hack a mis la main sur deux archives.</p>
<p>L&rsquo;une est chiffrée et l&rsquo;autre est en clair. Elle pense que les deux sont liés et que l&rsquo;archive chiffrée contient un indice important pouvant l&rsquo;aider dans sa quête de liberté. Un extrait de l&rsquo;historique de commande d&rsquo;un utilisateur montre que les deux fichiers ont été créés à la suite :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>zip archive.zip propaganda.png
</span></span><span style="display:flex;"><span>zip secret.zip propaganda.png secret.png
</span></span><span style="display:flex;"><span>python3 encrypt.py secret.zip
</span></span><span style="display:flex;"><span>rm secret.png
</span></span></code></pre></div><p>Par chance, elle a aussi exfiltré le script permettant de chiffrer cette archive, mais la clé utilisée semble aléatoire et impossible à retrouver.</p>
</blockquote>
<div style="text-align: center;">
  <img src="/images/writeup_crypto_2025/propaganda.png">
</div>
<p>Le but du challenge est de déchiffrer l&rsquo;archive <code>secret.zip.enc</code> qui a été chiffré à l&rsquo;aide du script <code>encrypt.py</code>. Les commandes utilisées pour chiffrer l&rsquo;archive indique que notre archive chiffrée contient 2 fichiers, un fichier <code>propaganda.png</code> et un autre <code>secret.png</code>, qui contient très probablement le flag. Une seconde archive est disponible (<code>archive.zip</code>), mais ne contient que la première image.</p>
<h3 id="analyse-du-script">Analyse du script</h3>
<p>Le premier élément à analyser est le script Python permettant de chiffrer l&rsquo;archive. On y trouve une classe <code>Random</code> qui implémente un générateur aléatoire, basé sur un état initiale.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Random</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># L&#39;état initial a une taille de 256 par défaut</span>
</span></span><span style="display:flex;"><span>    STATE_ELEM_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialise le générateur avec urandom</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, size: int<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>size <span style="color:#f92672">=</span> size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> [int<span style="color:#f92672">.</span>from_bytes(os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">1</span>)) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(size)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Génère le prochain entier aléatoireqca</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_next_number</span>(self):
</span></span><span style="display:flex;"><span>        number <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calcul d&#39;un nouvel entier à partir de l&#39;état interne</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>size):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                number <span style="color:#f92672">+=</span> pow(self<span style="color:#f92672">.</span>state[i], i, self<span style="color:#f92672">.</span>STATE_ELEM_MAX) <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>state[i] <span style="color:#f92672">*</span> i
</span></span><span style="display:flex;"><span>                number <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>number
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                number <span style="color:#f92672">^=</span> self<span style="color:#f92672">.</span>state[i] <span style="color:#f92672">*</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        number <span style="color:#f92672">%=</span> self<span style="color:#f92672">.</span>STATE_ELEM_MAX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Modification de l&#39;état interne</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>state[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>append(number)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> number
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Permet de générer plusieurs bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_random_bytes</span>(self, size: int<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>        random <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>            random <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>gen_next_number()<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> random
</span></span></code></pre></div><p>On peut y voir que la génération de chaque nouvel entier est basé sur l&rsquo;état interne du générateur, puis cet état est modifié à chaque nouvelle génération. On ne peut donc pas revenir en arrière à partir d&rsquo;un extrait de la sortie du générateur.</p>
<p>Il va donc falloir retrouver l&rsquo;état initial utilisé pour chiffrer notre archive. Cependant, l&rsquo;initialisation est basée sur <code>urandom</code> qui n&rsquo;est pas prédictible, il va donc falloir trouver un autre moyen pour le retrouver.</p>
<p>Si l&rsquo;on retrouve cet état initial, le chiffrement étant ensuite un simple XOR de la sortie du générateur avec le fichier, on pourra facilement déchiffrer notre archive.</p>
<h3 id="analyse-des-archives">Analyse des archives</h3>
<p>Le second point à remarquer est que lorsque l&rsquo;on compresse des fichiers avec <code>zip</code> ceux-ci sont stockés les uns à la suite des autres. La table contenant les informations et offsets des fichiers de l&rsquo;archive (appelé <em>central directory</em>) est situé <strong>à la fin</strong> du fichier ZIP, comme le montre ce schéma :</p>
<p><img src="/images/writeup_crypto_2025/zip64_structure.png" alt="zip"></p>
<p>De plus, si l&rsquo;on se fie aux commandes exécutées pour créer ces fichiers, les deux contiennent en tant que premier fichier, l&rsquo;image <code>propaganda.png</code>. Le format de fichier ZIP fait donc que nos deux archives (<code>archive.zip</code> et <code>secret.zip</code>) sont identiques au début, elles contiennent une version compressée de l&rsquo;image <code>propaganda.png</code>.</p>
<p>Et donc, si les deux fichiers sont identiques au début, en effectuant un XOR entre le fichier <code>archive.zip</code> et l&rsquo;archive chiffrée on peut récupérer un partie de la suite chiffrante ! Et grâce au fonctionnement de ce générateur aléatoire, si l&rsquo;on parvient à récupérer un extrait de cette suite (e.g. 256 octets étant donné que le fichier <code>encrypt.py</code> ne défini pas de taille pour la classe <code>Random</code>), on peut ensuite générer exactement la même sortie.</p>
<h3 id="script-de-solve">Script de solve</h3>
<p>Le but du script de solve est donc dans un premier temps de lire les 256 premiers octets de l&rsquo;archive chiffrée et de celle en clair afin d&rsquo;effectuer un XOR entre les deux et retrouver le début de la suite chiffrante.</p>
<p>Ensuite, on va pouvoir utiliser cette suite pour initialiser un nouveau générateur avec comme état initial, les 256 octets récupérés.</p>
<p>Et enfin on va pouvoir déchiffrer l&rsquo;archive par blocs en générant la même suite chiffrante que celle utilisée pour chiffrer le fichier et en effectuant un XOR. Un détail à ne pas oublier et que l&rsquo;on n&rsquo;a pas retrouvé l&rsquo;état initial du générateur aléatoire, mais seulement les 256 premiers octets de la suite. Il faut donc utiliser directement ces octets pour déchiffrer le premier bloc avant de générer la suite.</p>
<p>Le script au complet (le script n&rsquo;est pas opti et Python c&rsquo;est très lent, donc attention il faut quelques minutes pour déchiffrer l&rsquo;archive, d&rsquo;où l&rsquo;ajout de la progression 😉) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> encrypt <span style="color:#f92672">import</span> Random, xor, gen_blocks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(encrypted: bytes, block_size: int, generator: Random) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check if message is padded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span>(len(encrypted) <span style="color:#f92672">%</span> block_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    clear <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize all blocks</span>
</span></span><span style="display:flex;"><span>    blocks <span style="color:#f92672">=</span> gen_blocks(encrypted, block_size)
</span></span><span style="display:flex;"><span>    total <span style="color:#f92672">=</span> len(blocks)
</span></span><span style="display:flex;"><span>    progress <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Decrypt each block</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, block <span style="color:#f92672">in</span> enumerate(blocks):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Only for progress printing</span>
</span></span><span style="display:flex;"><span>        percent <span style="color:#f92672">=</span> round(i <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">/</span> total)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> percent <span style="color:#f92672">in</span> progress:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;[+] </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">% block decrypted&#34;</span><span style="color:#f92672">.</span>format(percent))
</span></span><span style="display:flex;"><span>            progress<span style="color:#f92672">.</span>remove(percent)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The first block is decrypted using generator state because we recover</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># the first 256 bytes generated not the state directly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>            clear <span style="color:#f92672">+=</span> xor(block, generator<span style="color:#f92672">.</span>state)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            clear <span style="color:#f92672">+=</span> xor(block, generator<span style="color:#f92672">.</span>gen_random_bytes(block_size))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> clear
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    archive <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;archive.zip&#34;</span>
</span></span><span style="display:flex;"><span>    secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;secret.zip.enc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Read first 256 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(archive, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> a, open(secret, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> s:
</span></span><span style="display:flex;"><span>        arch_clear <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">256</span>)
</span></span><span style="display:flex;"><span>        encrypted <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute initial state (not really but it&#39;s ok)</span>
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> xor(arch_clear, encrypted[:<span style="color:#ae81ff">256</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Init a new random generator and set state</span>
</span></span><span style="display:flex;"><span>    generator <span style="color:#f92672">=</span> Random()
</span></span><span style="display:flex;"><span>    generator<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> state]
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Computed state:&#34;</span>, generator<span style="color:#f92672">.</span>state)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Decrypt the file</span>
</span></span><span style="display:flex;"><span>    clear <span style="color:#f92672">=</span> decrypt(encrypted, <span style="color:#ae81ff">256</span>, generator)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Write to file system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;out.zip&#34;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> out:
</span></span><span style="display:flex;"><span>        out<span style="color:#f92672">.</span>write(clear)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Done !&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p>On peut finalement décompresser l&rsquo;archive et ouvrir le fichier <code>secret.png</code> qui contient le flag :</p>
<div style="text-align: center;">
  <img src="/images/writeup_crypto_2025/secret.png">
</div>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 no-underline white-70 dn dib-ns pv2 ph3" >
    &copy;  2025  Jeanne d'Hack CTF. Tous droits réservés. 
  </a>
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="/legal/" >
      Mentions légales
  </a>
  </div>
</footer>

  </body>
</html>
